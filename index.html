<script>
        // *** สำคัญ: แทนที่ด้วย URL ของ Google Apps Script Web App ล่าสุดของคุณ ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyRNJACyL4JE00hIas5n0GYxF_E9t2BolpG7IzsdKnsk-eThp8U3gb2XDZQ4E4Cf5id/exec'; 
        
        const form = document.getElementById('regForm');
        const statusDisplay = document.getElementById('status');
        const assignedTableDisplay = document.getElementById('assignedTableDisplay');

        // Function สำหรับพูดข้อความ
        function speakConfirmation(firstName, lastName, table) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance();
                utterance.lang = 'th-TH'; // กำหนดภาษาเป็นไทย
                utterance.text = `คุณ${firstName} ${lastName} ลงทะเบียนเรียบร้อยแล้วค่ะ โต๊ะ/ที่นั่งของคุณคือหมายเลข ${table} ค่ะ`;
                
                const voices = speechSynthesis.getVoices();
                const thaiVoice = voices.find(voice => voice.lang === 'th-TH');
                if (thaiVoice) {
                    utterance.voice = thaiVoice;
                } else {
                    console.warn("ไม่พบเสียงภาษาไทย ใช้เสียงเริ่มต้นแทน");
                }

                try {
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error("Error speaking:", error);
                    showStatus("เสียงไม่ดัง? กรุณาตรวจสอบปุ่มปรับเสียงของมือถือ หรือแตะที่หน้าจอเพื่อเปิดใช้งานเสียง.", "error");
                }

            } else {
                console.warn("เบราว์เซอร์ของคุณไม่รองรับ Speech Synthesis API");
            }
        }

        function showStatus(message, type, table = null) {
            statusDisplay.textContent = message;
            statusDisplay.className = `text-center text-sm ${type}`;
            statusDisplay.classList.add('visible');
            statusDisplay.style.display = 'block';

            if (table && type === 'success') {
                assignedTableDisplay.textContent = `โต๊ะ/ที่นั่งของคุณคือ: ${table}`;
                assignedTableDisplay.classList.add('visible');
                assignedTableDisplay.style.display = 'block';
            } else {
                assignedTableDisplay.classList.remove('visible');
                setTimeout(() => { assignedTableDisplay.style.display = 'none'; }, 300); 
            }

            setTimeout(() => {
                statusDisplay.classList.remove('visible');
                assignedTableDisplay.classList.remove('visible');
                setTimeout(() => { 
                    statusDisplay.style.display = 'none'; 
                    assignedTableDisplay.style.display = 'none'; 
                }, 300);
            }, 5000); 
        }

        // Helper function สำหรับจัดรูปแบบวันที่/เวลาเป็น พ.ศ.
        function formatThaiBuddhistDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            
            // ใช้ Intl.DateTimeFormat สำหรับ เดือน วัน และเวลา เพื่อความถูกต้องของ locale
            const dateFormatter = new Intl.DateTimeFormat('th-TH', { 
                day: 'numeric', 
                month: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false // ใช้รูปแบบ 24 ชั่วโมง
            });
            const formattedDatePart = dateFormatter.format(date);

            // คำนวณปีพุทธศักราชด้วยการบวก 543 จากปีคริสตศักราช
            const buddhistYear = date.getFullYear() + 543;

            // รวมเป็นสตริง "วัน/เดือน/ปี(พ.ศ.) เวลา"
            return `${formattedDatePart.split(',')[0]}/${buddhistYear} ${formattedDatePart.split(',')[1].trim()}`;
        }


        function updateSummary() {
            fetch(WEB_APP_URL + '?action=getData')
    .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
                })
                .then(data => {
                    const total = data.list.length;
                    const max = 71;
                    
                    // ใช้ฟังก์ชัน formatThaiBuddhistDate สำหรับ latestTime
                    const latest = data.list.length > 0 && data.list[0].timestamp 
                                ? formatThaiBuddhistDate(data.list[0].timestamp) 
                                : '-'; 

                    document.getElementById("summaryCount").textContent = `ลงทะเบียนแล้ว ${total} / ${max} คน`;
                    document.getElementById("summaryBar").style.width = `${(total / max) * 100}%`;
                    document.getElementById("latestTime").textContent = latest;
                })
                .catch(err => {
                    console.error("Failed to load summary:", err);
                    document.getElementById("summaryCount").textContent = `ไม่สามารถโหลดข้อมูลสรุปได้`;
                });
        }

        document.addEventListener("DOMContentLoaded", updateSummary);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            showStatus('กำลังส่งข้อมูล...', 'loading');
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            // ส่วนนี้บันทึกวันที่ลงทะเบียนลง Google Sheet ด้วย locale ของ GAS
            data.timestamp = new Date().toLocaleString('th-TH'); 
            
            try {
                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(data),
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Server responded with status ${res.status}: ${errorText}`);
                }

                const result = await res.json();

                if (result.success) {
                    showStatus(result.message, 'success', result.table); 
                    form.reset();
                    updateSummary();
                    toggleTable(true);
                    
                    setTimeout(() => {
                        if (result.firstName && result.lastName && result.table) {
                            speakConfirmation(result.firstName, result.lastName, result.table);
                        }
                    }, 100); 
                    

                } else {
                    showStatus(result.message, 'error');
                }
            } catch (error) {
                console.error("Error during submission:", error);
                showStatus('❌ เกิดข้อผิดพลาดในการลงทะเบียน กรุณาลองใหม่อีกครั้ง', 'error');
            } finally {
                submitButton.disabled = false;
            }
        });

        function toggleTable(forceRefresh = false) { 
            const section = document.getElementById("tableSection");
            const nameTable = document.getElementById("nameTable");

            section.classList.toggle("hidden");

            if (!section.classList.contains("hidden") && (!section.classList.contains("loaded") || forceRefresh)) {
                nameTable.innerHTML = `<tr><td colspan="3" class="text-center py-2 text-blue-500">กำลังโหลดข้อมูล...</td></tr>`; 
                fetch(WEB_APP_URL + '?action=getData')
    .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
                    })
                    .then(data => {
                        nameTable.innerHTML = "";
                        if (data.list && data.list.length > 0) {
                            data.list.forEach(item => {
                                // ใช้ฟังก์ชัน formatThaiBuddhistDate สำหรับ displayTime ในตาราง
                                const displayTime = formatThaiBuddhistDate(item.timestamp);

                                nameTable.innerHTML += `
                                    <tr>
                                        <td class="px-4 py-1 whitespace-nowrap">${item.name || ''}</td>
                                        <td class="px-4 py-1 whitespace-nowrap">${displayTime}</td> 
                                        <td class="px-4 py-1 whitespace-nowrap">${item.assignedTable || '-'}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            nameTable.innerHTML = `<tr><td colspan="3" class="text-center py-2 text-gray-500">ยังไม่มีผู้ลงทะเบียน</td></tr>`; 
                        }
                        section.classList.add("loaded");
                    })
                    .catch(err => {
                        console.error("Failed to load table data:", err);
                        nameTable.innerHTML = `<tr><td colspan="3" class="text-center py-2 text-red-500">❌ โหลดข้อมูลไม่สำเร็จ</td></tr>`; 
                    });
            } else if (section.classList.contains("hidden")) {
                section.classList.remove("loaded"); 
            }
        }
    </script>
